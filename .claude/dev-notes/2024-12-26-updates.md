# 开发更新日志 (2024-12-26)

本文档总结了从 commit `8d7a2b4` 开始的所有更新。

## 概览

| Commit    | 类型     | 描述                           |
| --------- | -------- | ------------------------------ |
| `aabf7a7` | refactor | 迁移到 sonner                  |
| `0188869` | refactor | 新建/修改文章页面合二为一      |
| `4687286` | fix      | 修复分类过滤返回所有文章的问题 |
| `12ab699` | chore    | 升级到 Tailwind CSS v4         |
| `7336545` | feat     | 更换 Markdown 编辑器           |
| `aaac87f` | chore    | 修改端口                       |
| `8d7a2b4` | feat     | 改进文章搜索功能               |

---

## 详细更新

### 1. 改进文章搜索功能 (`8d7a2b4`)

**后端改动：**

- 支持多关键词搜索，空格分隔的关键词用 OR 连接
- 文件：`apps/backend/src/controllers/postController.ts`

**前端改动：**

- 搜索改为点击按钮时才触发，避免输入时频繁请求
- 文件：`apps/frontend-admin/src/routes/_app.posts.index.tsx`

---

### 2. 修改端口 (`aaac87f`)

- 调整开发服务器端口配置

---

### 3. 更换 Markdown 编辑器 (`7336545`)

**新增文件：**

- `apps/frontend-admin/src/components/ui/milkdown-editor.tsx` - 基于 Milkdown 的新编辑器组件
- `apps/frontend-admin/src/styles/milkdown.css` - 编辑器样式

**改动：**

- 使用 Milkdown 替代旧的 Markdown 编辑器
- 支持 ref 暴露编辑器实例

---

### 4. 升级到 Tailwind CSS v4 (`12ab699`)

**主要改动：**

1. **配置变更：**
   - 删除 `tailwind.config.js`
   - 更新 `postcss.config.js` 使用 `@tailwindcss/postcss`
   - 更新 `components.json` 配置

2. **CSS 变量迁移：**
   - `src/index.css` 从 `@layer base` 改为 `@theme` 块
   - 使用新的 CSS 变量语法

3. **组件更新（使用新版 shadcn/ui）：**
   - `alert-dialog.tsx`
   - `avatar.tsx`
   - `badge.tsx`
   - `button.tsx`
   - `card.tsx`
   - `dialog.tsx`
   - `dropdown-menu.tsx`
   - `input.tsx`
   - `label.tsx`
   - `select.tsx`
   - `separator.tsx`
   - `table.tsx`
   - `textarea.tsx`

---

### 5. 修复分类过滤返回所有文章的问题 (`4687286`)

**问题：**
当选择没有任何文章的分类时，原逻辑会跳过过滤条件，导致返回所有文章。

**修复：**
添加不可能满足的条件确保返回空结果。

**文件：**

- `apps/backend/src/controllers/postController.ts`

---

### 6. 新建/修改文章页面合二为一 (`0188869`)

**改动：**

- 合并 `_app.posts.new.tsx` 和 `_app.posts.$id.edit.tsx`
- 使用 `id === "new"` 作为魔法值区分新建和编辑模式
- 路由 `/posts/new/edit` 用于新建，`/posts/{id}/edit` 用于编辑

**删除文件：**

- `apps/frontend-admin/src/routes/_app.posts.new.tsx`

**主要代码变更：**

```typescript
// 检测是否为新建模式
const isNew = id === "new";

// 条件性加载文章数据
const { data: postData } = useQuery({
  queryKey: ["post", id],
  queryFn: () => getPost(Number(id)),
  enabled: !isNew, // 新建模式不加载
});

// 动态表单默认值
defaultValues: isNew
  ? {
      /* 空值 */
    }
  : {
      /* 文章数据 */
    };

// 动态 mutation
mutationFn: isNew ? createPost : updatePost;
```

---

### 7. 迁移到 sonner (`aabf7a7`)

**改动：**

- 从旧版 shadcn/ui 的 `useToast` hook 迁移到 `sonner`
- 使用更简洁的 API

**API 变更：**

```typescript
// 旧版
import { useToast } from "@/hooks/use-toast";
const { toast } = useToast();
toast({ title: "Success" });
toast({ title: "Error", variant: "destructive" });

// 新版
import { toast } from "sonner";
toast.success("Success");
toast.error("Error");
toast.error("Error", { description: "详细信息" });
```

**更新的文件：**

- `_app.posts.$id.edit.tsx`
- `_app.posts.index.tsx`
- `_app.categories.tsx`
- `_auth.login.tsx`

**删除的文件：**

- `src/hooks/use-toast.ts`
- `src/components/ui/toast.tsx`
- `src/components/ui/toaster.tsx`

**新增文件：**

- `src/components/ui/sonner.tsx` - Sonner Toaster 组件

---

## 依赖变更

主要更新的包：

- `tailwindcss` -> v4
- `@tailwindcss/postcss` (新增)
- `sonner` (新增)
- `@milkdown/*` (新增) - Markdown 编辑器

删除的包：

- 旧版 tailwindcss 相关配置依赖
